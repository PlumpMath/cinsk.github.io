<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>cinsk's yard</title>


    <!-- Le styles -->
    <link href="http://cinsk.github.io/css/bootstrap.css" rel="stylesheet"/>
    <link href="http://cinsk.github.io/css/bootstrap-responsive.css"
          rel="stylesheet"/>
    <link href="http://cinsk.github.io/css/docs.css" rel="stylesheet"/>
    <link href="http://cinsk.github.io/prettify.css" rel="stylesheet"/>
    <link href="../../../css/articles.css" rel="stylesheet"/>

    <link rel="alternate" type="application/rss+xml" title="RSS"
          href="/feed.xml">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144"
          href="http://cinsk.github.io/ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114"
          href="http://cinsk.github.io/ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72"
          href="http://cinsk.github.io/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed"
          href="http://cinsk.github.io/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="http://cinsk.github.io/ico/favicon.png"/>

    <link href="/css/org.css" rel="stylesheet"/>
    <link href="/css/articles.css" rel="stylesheet"/>

    <script type="text/javascript" src="http://orgmode.org/mathjax/MathJax.js">
      <!--/*--><![CDATA[/*><!--*/
    MathJax.Hub.Config({
        // Only one of the two following lines, depending on user settings
        // First allows browser-native MathML display, second forces HTML/CSS
        //  config: ["MMLorHTML.js"], jax: ["input/TeX"],
            jax: ["input/TeX", "output/HTML-CSS"],
        extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                     "TeX/noUndefined.js"],
        tex2jax: {
            inlineMath: [ ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"], ["\\begin{displaymath}","\\end{displaymath}"] ],
            skipTags: ["script","noscript","style","textarea","pre","code"],
            ignoreClass: "tex2jax_ignore",
            processEscapes: false,
            processEnvironments: true,
            preview: "TeX"
        },
        showProcessingMessages: true,
        displayAlign: "center",
        displayIndent: "2em",

        "HTML-CSS": {
             scale: 100,
             availableFonts: ["STIX","TeX"],
             preferredFont: "TeX",
             webFont: "TeX",
             imageFont: "TeX",
             showMathMenu: true,
        },
        MMLorHTML: {
             prefer: {
                 MSIE:    "MML",
                 Firefox: "MML",
                 Opera:   "HTML",
                 other:   "HTML"
             }
        }
    });
/*]]>*///-->
    </script>
  </head>

  <body data-spy="scroll" data-target=".bs-docs-sidebar">
    <!-- Navbar
    ================================================== -->
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="./index.html">cinsk.org</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <!-- toplink: invalid parameter, label() not found -->

              <!--
              id: home<br/>
              label: Home<br/>
              locale: <br/>
              url: ../../../home/cinsk/www/www/index.html<br/>
              self: false<br/>
              -->
              
              <li class="active"><a href="../../../home/cinsk/www/www/index.html">Home</a></li>
              
              
              <!--
              id: cfaq<br/>
              label: C FAQ<br/>
              locale: <br/>
              url: ../../../home/cinsk/www/www/cfaqs/index.html<br/>
              self: false<br/>
              -->
              
              <li class=""><a href="../../../home/cinsk/www/www/cfaqs/index.html">C FAQ</a></li>
              
              
              <!--
              id: article<br/>
              label: Articles<br/>
              locale: <br/>
              url: ../../../home/cinsk/www/www/articles.html<br/>
              self: false<br/>
              -->
              
              <li class=""><a href="../../../home/cinsk/www/www/articles.html">Articles</a></li>
              
              
              <!--
              id: emacs<br/>
              label: Emacs<br/>
              locale: <br/>
              url: ../../../home/cinsk/www/www/emacs/index.html<br/>
              self: false<br/>
              -->
              
              <li class=""><a href="../../../home/cinsk/www/www/emacs/index.html">Emacs</a></li>
              
              
              <!--
              id: resume<br/>
              label: Résumé<br/>
              locale: <br/>
              url: ../../../home/cinsk/www/www/resume.html<br/>
              self: false<br/>
              -->
              
              <li class=""><a href="../../../home/cinsk/www/www/resume.html">Résumé</a></li>
              
              

              <!--
              
                -->
            </ul>
          </div>
        </div>
      </div>
    </div>

<!-- Subhead
================================================== -->
<header class="jumbotron subhead" id="overview">
  <div class="container">
    <h1>cinsk's yard</h1>
    <!-- <p class="lead">Easy way to connect Scalr-managed servers</p> -->
  </div>
</header>

  <div class="container">

    <div class="row">
      <div class="span10"></div>
      <div class="span2">
        <!-- This div should be floating and should not scroll,
             but I don't know anything about CSS, *sigh* -- cinsk -->
        <section id="lang">
          <-- DEBUG: url[en]:  --><-- DEBUG: url[ko]:  -->
        </section>
      </div>
    </div>

    <div class="row">
      <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Backgrounds</a></li>
<li><a href="#sec-2">2. Download &amp; Installation</a></li>
<li><a href="#sec-3">3. Usage</a></li>
</ul>
</div>
</div>
<header>
  <h2 class='article-title'>Easy way to connect Scalr-managed servers</h2>
</header>
<aside class='article-meta'>
  <ul class='unstyled'>
    <li class="date"><strong>13 Feb 2014</strong></li>
    <li class="tags">Scalr, firewall, proxy, and ssh</li>
  </ul>
</aside>
<p>It's annoying to connect one of the virtual machine managed by Scalr for various reasons. So I created small shell script for easy connection; browse the servers with its IP address, then connect to them.
<span id="continue"></span></p>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Backgrounds</h2>
<div class="outline-text-2" id="text-1">
<p>
We created lots of Scalr managed servers. Some of them have external
IP addresses, but some of them are not.  So, we need to prepare a
proxy machine, to connect those servers.
</p>

<pre>
                            |
            Internet     Firewall     Cloud IaaS
                            |  
  +---------+          +----+----+         +---------+
  | Client  |          | Proxy   |         | Target  |
  | Machine |          | Server  |         | Server  |
  |         |--------->|         |-------->|         |
  |         |          |         |         |         |
  |         |          |         |         |         |
  +---------+          +----+----+         +---------+
                   53.208.160.176        10.102.9.203
                            |
</pre>

<p>
For example, suppose that we've prepared the proxy machine at
53.208.160.176.  Normally, you could connect to the destination
server 10.102.9.203 by issuing <code>ssh</code> twice, like this (which is
annoying):
</p>

<div class="org-src-container">

<pre class="src src-sh">$ ssh 53.208.160.176
$ ssh 10.102.9.203
</pre>
</div>

<p>
We are using Scalr's auto-scaling feature; this means, the number of
servers are dynamically increasing/decreasing depending on the
server's load.  In other words, at some instance, we do not exactly
know how many servers are there, and we do not exactly know what IP
addresses they have.
</p>

<p>
So, I created small shell script named <code>sssh</code> (stands for
"Scalr-ssh") to find out the list of Scalr-managed servers, and
provide easy <code>ssh</code> connection to one of the servers.  With this, you
can connect a server instantly even if the server does not have
external IP address.
</p>
</div>
</section>
<section id="sec-2">
<div id="outline-container-2">
<div class="page-header">
<h1><span class="section-number-2">2</span> Download &amp; Installation</h1>
</div>
</div>
<div class="outline-text-2" id="text-2">
<p>
First, you'll need to download the Scalr command line tool from
<a href="https://scalr-wiki.atlassian.net/wiki/display/docs/Scalr+Command+Line+Tools">Scalr Command Line Tools</a>, and you'll need to finish <code>scalr
  configure</code> step.
</p>

<div class="org-src-container">

<pre class="src src-sh">$ sudo easy_install scalr
$ scalr configure -i d41d8cd98f00b204 <span class="org-sh-escaped-newline">\</span>
    -a 3bEGXWzaoT92BMhOaqv13bEGXWzaoT92BMhOaqv13bEGXWzaoT92BMhOaqv1+<span class="org-variable-name">0</span>=
</pre>
</div>

<p>
Above example will save your configuration in <code>$HOME/.scalr/config.ini</code>.
</p>

<p>
Then, you'll need to grab the source from <a href="https://github.com/cinsk/snippets/blob/master/sssh">here</a>, and save it to some place like
<code>/usr/local/bin</code>.   Then, edit that file to update the proxy endpoint
in <code>SSH_PROXY_ENDPOINT</code> to reflect your proxy endpoint.  For example:
</p>

<div class="org-src-container">

<pre class="src src-sh"><span class="org-variable-name">SSH_PROXY_ENDPOINT</span>=${<span class="org-variable-name">SSH_PROXY_ENDPOINT</span>:=<span class="org-string">"root@53.208.160.176}</span>
</pre>
</div>

<p>
You can test whether the installation was successful via following
command.  Note that the actual output may vary depending on your
Scalr configuration/usage.
</p>

<div class="org-src-container">

<pre class="src src-sh">$ sssh env
  [149]  AWS-TEST-ENV
  [158]  US-EAST-9
  [161]  AP-KR-FOOBAR
</pre>
</div>
</div>
</section>
<section id="sec-3">
<div id="outline-container-3">
<div class="page-header">
<h1><span class="section-number-2">3</span> Usage</h1>
</div>
</div>
<div class="outline-text-2" id="text-3">
<p>
If you have more than one Scalr environment, you'll need to list the
environments using <code>sssh env</code>, then select one of the environment
with the following command:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ <span class="org-comment-delimiter"># </span><span class="org-comment">select environment with id, 158</span>
$ sssh set-env 158
</pre>
</div>

<p>
Then, you'll need to select one of your farms.  First, list the farms
using <code>sssh farms</code>, then select one of it using <code>sssh set-farm</code>:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ <span class="org-comment-delimiter"># </span><span class="org-comment">list the farms</span>
$ sssh farms
  [808]                          test-vpc (Stopped):   VPC farm for testing
  [809]      ec2-us-east-1-management-dev (Running):   None
  [814]           ec2-us-east-2-store-dev (Stopped):   None
  [953]                template-test-farm (Running):   None
$ <span class="org-comment-delimiter"># </span><span class="org-comment">select one of the farm</span>
$ sssh set-farm 809
</pre>
</div>

<p>
Once the env/farm is selected, then you can browse the list of servers
by <code>sssh list</code>:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ sssh list
  [ 0]   53.208.160.176    10.102.9.174  proxy-server
  [ 1]      53.84.9.110    10.102.9.135  zookeeper-3-centos6-cl
  [ 2]     53.84.76.146    10.102.9.146  zookeeper-3-centos6-cl
  [ 3]     53.84.65.212      10.102.9.7  zookeeper-3-centos6-cl
  [ 4]             None    10.102.9.203  sessionmgr-master-centos6-cl
  [ 5]     53.84.72.223    10.102.9.132  cs-sessionmgr-master-centos6-cl
  [ 6]     53.84.74.122     10.102.9.52  cs-sessionmgr-master-centos6-cl
  [ 7]     53.84.64.155    10.102.9.112  cs-frontend-centos6-cl
  [ 8]       53.84.0.88    10.102.9.106  cs-frontend-centos6-cl
  [ 9]             None    10.102.3.210  cs-datastore-centos6-cl
</pre>
</div>

<p>
Each item contains 4 fields: the server index, the external IP,
the internal IP, and the name of the server.  In above example,
4th and 9th server do not have external IP.   Remember that
we configured <code>SSH_PROXY_ENDPOINT</code> to point 0-th server endpoint,
"root@53.208.160.176".  This server is used for the ssh proxy for
this demonstration.
</p>

<p>
These servers belong to the farm id, 809 as we selected this farm
using <code>sssh set-farm 809</code>.  To connect one of these servers, you
need to download the PEM file of this farm, and place it in your
<code>$HOME/.ssh/809.pem</code>.   Finally, you can connect to one of the
servers by following command:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ <span class="org-comment-delimiter"># </span><span class="org-comment">connect to 1st server</span>
$ sssh connect 1
Last login: Tue Feb 11 05:32:28 2014 from 124.168.108.138

Appliance:      centos-6-scalr appliance 1.0
Hostname:       ip-10-102-9-135
IP Address:     10.102.9.135

[root@ec2-53-84-9-110 ~]# _
</pre>
</div>

<p>
You can even connect to the server without external IP.  For example:
</p>

<div class="org-src-container">

<pre class="src src-sh">$ <span class="org-comment-delimiter"># </span><span class="org-comment">connect to 9th server</span>
$ sssh connect 9
Last login: Wed Feb 12 09:04:02 2014 from 10.102.9.174

Appliance:      centos-6-scalr appliance 1.0
Hostname:       ip-10-102-9-210
IP Address:     10.102.9.210

[root@ip-10-101-3-210 ~]# _
</pre>
</div>

<p>
Note that from the first message of the command;  it says that
the connection was from <code>10.102.9.174</code>, which is the internal
IP address of the 0-th server, which is used for the ssh proxy.
</p>

<p>
Internally, when we specify a server without external IP address,
<code>sssh</code> will indirectly connect to the server via the pre-configured
ssh proxy server using ssh <span class="underline">ProxyCommand</span> option with netcat(1):
</p>

<div class="org-src-container">

<pre class="src src-sh">ssh -i <span class="org-string">"$pem"</span> -o <span class="org-string">"ProxyCommand ssh -i $pem $SSH_PROXY_ENDPOINT nc %h %p"</span> root@${<span class="org-variable-name">iip</span>}
</pre>
</div>

<p>
If you have interest on this, read the nice article <a href="http://www.linuxsysadmintutorials.com/configure-openssh-to-tunnel-through-another-server-using-ssh/">Configure openssh to
tunnel through another server using SSH</a>.
</p>
</div>

</section>



      <hr/>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'cinsk'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>

    <!-- Footer
    ================================================== -->
    <footer class="footer">
      <div class="container">
        <p>Copyright &copy; 2013  Seong-Kook Shin;  All rights reserved except, </p>
        <p>CSS design, layouts are reserved to <a href="https://github.com/twitter/bootstrap/">bootstrap</a>,</p>
        <p>Icons and symbols are reserved to <a href="http://glyphicons.com">Glyphicons</a></p>
        <!--
        <p>Designed and built with all the love in the world by <a href="http://twitter.com/mdo" target="_blank">@mdo</a> and <a href="http://twitter.com/fat" target="_blank">@fat</a>.</p>
        <p>Code licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License v2.0</a>, documentation under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</p>
        <p><a href="http://glyphicons.com">Glyphicons Free</a> licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.</p>
        <ul class="footer-links">
          <li><a href="http://blog.getbootstrap.com">Blog</a></li>
          <li class="muted">&middot;</li>
          <li><a href="https://github.com/twitter/bootstrap/issues?state=open">Issues</a></li>
          <li class="muted">&middot;</li>
          <li><a href="https://github.com/twitter/bootstrap/wiki">Roadmap and changelog</a></li>
        </ul>
        -->
      </div>
    </footer>



    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    <script type="text/javascript"
            src="http://platform.twitter.com/widgets.js"></script>

    <script src="http://www.cinsk.org/bootstrap/js/jquery.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-transition.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-alert.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-modal.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-dropdown.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-scrollspy.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-tab.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-tooltip.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-popover.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-button.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-collapse.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-carousel.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-typeahead.js"></script>
    <script src="http://cinsk.github.io/js/bootstrap-affix.js"></script>

    <script src="http://cinsk.github.io/js/holder/holder.js"></script>
    <script src="http://cinsk.github.io/prettify.js"></script>

    <script src="http://cinsk.github.io/js/application.js"></script>

  </body>
</html>
